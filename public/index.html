<script>
// ------- config -------
const CLOUD = "dvqpndvej";          // your Cloudinary cloud
const VENUES = ["chiefs-luau","ka-moana-luau"];
const MONTHS = ["January","February","March","April","May","June","July","August",
                "September","October","November","December"];

// ------- tiny DOM helpers -------
const $  = s => document.querySelector(s);
const msg = $("#msg") || { textContent: "" };
const grid = $("#grid") || (function(){ const d=document.createElement("div"); d.id="grid"; document.body.appendChild(d); return d; })();

function addCard(url, label="") {
  const card = document.createElement("div");
  card.style.cssText = "width:320px;border:1px solid #1e293b;border-radius:10px;overflow:hidden;background:#0b1220";
  card.innerHTML = `
    <img src="${url}" style="display:block;width:100%;height:auto" />
    <div style="padding:8px 10px;color:#cbd5e1;font:14px system-ui, sans-serif;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;">
      ${label}
    </div>`;
  grid.appendChild(card);
}

function loadImg(url){  // no HEAD/CORS—just let <img> tell us
  return new Promise(res => {
    const i = new Image();
    i.onload  = () => res({ok:true, url});
    i.onerror = () => res({ok:false, url});
    i.src = url;
  });
}

// Turn whatever the user typed into a photo id or url
function normalizeInput(raw) {
  const s = (raw||"").trim();
  if (!s) return { kind:"empty" };
  if (/res\.cloudinary\.com/.test(s)) return { kind:"fullUrl", url:s };
  return { kind:"shortId", id:s };
}

function publicIdFromUrl(fullUrl){
  const m = fullUrl.match(/\/image\/upload\/(?:v\d+\/)?(.+?)\.\w+$/);
  return m ? m[1] : null;
}

function neighborsOf(id){
  const digits = (id.match(/(\d+)$/)||[])[1] || "";
  const prefix = id.slice(0, id.length - digits.length);
  const n = parseInt(digits||"0",10);
  return [`${prefix}${n-1}`, `${prefix}${n}`, `${prefix}${n+1}`];
}

function deliveryUrl(pubId){ return `https://res.cloudinary.com/${CLOUD}/image/upload/${pubId}.jpg`; }

// Probe recent dates to find the folder of the main image
async function findMainUrlById(shortId, daysBack=90){
  const today = new Date();
  for (let d=0; d<=daysBack; d++){
    const dt = new Date(today.getTime() - d*86400000);
    const Y = dt.getFullYear();
    const Mtxt = MONTHS[dt.getMonth()];
    const mdY = String(dt.getMonth()+1).padStart(2,"0")+"."+String(dt.getDate()).padStart(2,"0")+"."+Y;

    for (const v of VENUES){
      // try month-in-path
      const p1 = `${v}/${Y}/${Mtxt}/${mdY}/${shortId}`;
      const u1 = deliveryUrl(p1);
      if ((await loadImg(u1)).ok) return u1;

      // try no-month
      const p2 = `${v}/${Y}/${mdY}/${shortId}`;
      const u2 = deliveryUrl(p2);
      if ((await loadImg(u2)).ok) return u2;
    }
  }
  return null;
}

async function showFromFolder(folder, fileId){
  // build prev, current, next
  const [prev, cur, next] = neighborsOf(fileId);
  const urls = [`${folder}/${prev}.jpg`, `${folder}/${cur}.jpg`, `${folder}/${next}.jpg`];
  const checks = await Promise.all(urls.map(u => loadImg(u)));
  const found = checks.filter(c => c.ok);
  if (!found.length){ msg.textContent = "Couldn’t load neighbors in that folder."; return; }
  // labels
  const labels = ["Previous", "This photo", "Next"];
  for (let i=0;i<found.length;i++){
    const label = labels[[prev,cur,next].indexOf(found[i].url.split("/").pop().replace(".jpg",""))] || "";
    addCard(found[i].url, label);
  }
}

async function onGo(){
  try{
    grid.innerHTML = "";
    msg.textContent = "Searching…";
    const raw = ($("#photoId")||document.querySelector('input[type="text"]')).value.trim();
    if (!raw){ msg.textContent = "Please enter a Photo ID."; return; }

    const norm = normalizeInput(raw);
    let mainUrl = null;

    if (norm.kind === "fullUrl"){
      mainUrl = norm.url;
    } else {
      // typed just CH… -> find folder by probing recent dates
      mainUrl = await findMainUrlById(norm.id, 90);
      if (!mainUrl){ msg.textContent = "Sorry, we couldn’t find that ID recently."; return; }
    }

    // derive folder + file from the working URL
    const pubId = publicIdFromUrl(mainUrl);
    if (!pubId){ msg.textContent = "Could not parse URL."; return; }
    const folder = `https://res.cloudinary.com/${CLOUD}/image/upload/${pubId.replace(/\/[^/]+$/,"")}`;
    const fileId = pubId.split("/").pop();

    await showFromFolder(folder, fileId);
    msg.textContent = "Done.";
  } catch(e){
    msg.textContent = "Error. Check DevTools console.";
    console.error(e);
  }
}

// wire up button (works with your existing page)
const goBtn = document.getElementById("goBtn") || document.querySelector('button');
if (goBtn) goBtn.onclick = onGo;
</script>
