<script>
const CLOUD = "dvqpndvej"; // your cloud name
const $ = s => document.querySelector(s);
const row = $("#row"); const msg = $("#msg");
function card(url, label){
  const el = document.createElement("div");
  el.className = "card";
  el.innerHTML = `
    <img src="${url}" style="display:block;width:100%;height:auto" />
    <div style="padding:6px 8px;font:14px system-ui, sans-serif;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;">
      ${label}<br/>
      <span style="font-size:12px;color:#8aa">${url.replace(/^https?:\/\/[^/]+\/image\/upload\//,'')}</span>
    </div>`;
  const img = el.querySelector("img");
  img.onerror = () => el.remove(); // if it 404s, just remove that card
  row.appendChild(el);
}
function delivery(pubId){ return `https://res.cloudinary.com/${CLOUD}/image/upload/${pubId}.jpg`; }

async function findMainPublicId(shortOrPath){
  // If the user pasted a full Cloudinary URL, turn it into public_id
  if (/res\.cloudinary\.com/.test(shortOrPath)) {
    const m = shortOrPath.match(/\/image\/upload\/(?:v\d+\/)?(.+?)(?:\.\w+)?$/);
    if (m) return m[1];
  }
  // If they pasted a full folder path (chiefs-luau/.../CH...), use it as-is
  if (shortOrPath.includes("/")) return shortOrPath;

  // They typed a short ID like CH0928251007: probe recent dates to find the folder
  const id = shortOrPath.trim();
  const months = ["January","February","March","April","May","June","July","August","September","October","November","December"];
  const today = new Date();
  // try last ~90 days, month-in-path first then no-month
  for (let d=0; d<90; d++){
    const dt = new Date(today.getTime()-d*86400000);
    const Y = dt.getFullYear();
    const M = months[dt.getMonth()];
    const mdY = String(dt.getMonth()+1).padStart(2,"0")+"."+String(dt.getDate()).padStart(2,"0")+"."+Y;
    const venue = id.startsWith("KL") ? "ka-moana-luau" : "chiefs-luau";
    const candidates = [
      `${venue}/${Y}/${M}/${mdY}/${id}`,
      `${venue}/${Y}/${mdY}/${id}`,
    ];
    for (const p of candidates){
      // quick existence check by creating an <img>; faster than HEAD and avoids CORS
      const ok = await new Promise(res=>{
        const img = new Image();
        img.onload = ()=>res(true);
        img.onerror = ()=>res(false);
        img.src = delivery(p)+"?cb="+Date.now();
      });
      if (ok) return p;
    }
  }
  return null;
}

async function loadIndexTxt(folderPublicId){
  // index.txt sits under the SAME folder as the images, but via /raw/upload/
  const url = `https://res.cloudinary.com/${CLOUD}/raw/upload/${folderPublicId}/index.txt?cb=`+Date.now();
  const res = await fetch(url, { cache:"no-store" });
  if (!res.ok) return null;
  const txt = await res.text();
  const lines = txt.split(/\r?\n/).map(s=>s.trim()).filter(Boolean);
  return lines; // array of CH… names (no .jpg)
}

function neighborsFromIndex(names, file){
  const i = names.indexOf(file);
  if (i === -1) return { prev:null, cur:file, next:null };
  return {
    prev: names[i-1] ?? null,
    cur:  names[i],
    next: names[i+1] ?? null
  };
}

$("#goBtn").onclick = async () => {
  row.innerHTML = "";
  msg.textContent = "Searching…";

  const raw = document.querySelector('input[type="text"]').value.trim();
  if (!raw){ msg.textContent = "Please enter a Photo ID."; return; }

  // 1) find the MAIN photo's public_id (discovers the correct folder)
  const mainPubId = await findMainPublicId(raw);
  if (!mainPubId){ msg.textContent = "Sorry, we couldn’t find that ID recently."; return; }

  const folder = mainPubId.replace(/\/[^/]+$/, ""); // drop filename
  const file   = mainPubId.split("/").pop();

  // 2) read index.txt from that folder and compute neighbors by position
  const names = await loadIndexTxt(folder);
  if (!names){ msg.innerHTML = "index.txt not found in <span style='color:#9fd'>" + folder + "</span>"; return; }
  const set = neighborsFromIndex(names, file);

  msg.innerHTML = "Done.";

  // 3) render CARDS (prev, current, next). Missing ones auto-disappear on 404.
  if (set.prev) card(delivery(`${folder}/${set.prev}`), "Previous");
  card(delivery(`${folder}/${set.cur}`), "This photo");
  if (set.next) card(delivery(`${folder}/${set.next}`), "Next");
};
</script>
