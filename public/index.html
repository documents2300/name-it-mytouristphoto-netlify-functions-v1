<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>MyTouristPhoto — Netlify Functions Demo</title>
  <style>
    body{font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;max-width:920px;margin:24px auto;padding:0 16px}
    input,button{font-size:16px;padding:10px}
    .row{display:flex;gap:16px;flex-wrap:wrap;margin-top:16px}
    .card{border:1px solid #ddd;border-radius:10px;padding:12px;width:280px}
    .card img{width:100%;height:auto;border-radius:8px}
    .action{margin-top:8px}
    .err{color:#b00;margin-top:10px}
  </style>
</head>
<body>
  <h1>MyTouristPhoto — Preview & One-Free-Download</h1>
  <p>Enter a Photo ID (e.g., <code>ch1001251011</code> or a real one) and click Load.</p>
  <input id="photoId" placeholder="Photo ID"/>
  <button id="loadBtn">Load Gallery</button>

  <div id="gallery" class="row"></div>
  <div id="msg" class="err"></div>

<script>
const $ = (s)=>document.querySelector(s);
$("#loadBtn").onclick = async () => {
  $("#gallery").innerHTML = "";
  $("#msg").textContent = "";
  const id = $("#photoId").value.trim();
  if (!id) return;
  try {
    // Using redirected path /api/gallery/<id> → /.netlify/functions/gallery/<id>
    const r = await fetch(`/api/gallery/${encodeURIComponent(id)}`);
    if (!r.ok) throw new Error("Not found");
    const data = await r.json();
    render(data, id);
  } catch (e) {
    $("#msg").textContent = e.message;
  }
};
function render(data, photoId) {
  const $g = $("#gallery");
  data.assets.forEach(a => {
    const el = document.createElement("div");
    el.className = "card";
    el.innerHTML = \`
      <div><strong>\${a.label}</strong></div>
      <img src="\${a.previewUrl}" alt="\${a.label}" />
      <div class="action"></div>
    \`;
    const act = el.querySelector(".action");
    if (a.action.type === "free") {
      const b = document.createElement("button");
      b.textContent = "Get Free Download";
      b.onclick = async () => {
        const r = await fetch("/api/redeem", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ photoId, publicId: a.publicId })
        });
        const out = await r.json();
        if (!r.ok) { alert(out.error || "Error"); return; }
        window.location.href = out.downloadUrl;
      };
      act.appendChild(b);
    } else if (a.action.type === "download") {
      const l = document.createElement("a");
      l.href = a.action.url;
      l.textContent = "Download";
      l.target = "_blank";
      l.rel = "noopener";
      act.appendChild(l);
    } else {
      const b = document.createElement("button");
      b.textContent = "Buy (coming soon)";
      b.disabled = true;
      act.appendChild(b);
    }
    $g.appendChild(el);
  });
}
</script>
</body>
</html>
