<script>
  // ===== CONFIG =====
  const CLOUD = "dvqpndvej";                 // your Cloudinary cloud
  const LOOKBACK_DAYS = 120;

  // ===== small helpers =====
  const $ = s => document.querySelector(s);
  const msg = $("#msg");
  const grid = $("#grid");

  function venueFromId(id) {
    const p = String(id || "").toUpperCase();
    return p.startsWith("KL") ? "ka-moana-luau" : "chiefs-luau";
  }

  function deliveryUrl(pubId){
    return `https://res.cloudinary.com/${CLOUD}/image/upload/${pubId}.jpg`;
  }
  function rawUrl(folder){
    return `https://res.cloudinary.com/${CLOUD}/raw/upload/${folder}/index.txt`;
  }

  function plusMinusOne(id){
    const digits = (String(id).match(/(\d+)$/) || [])[1] || "";
    const prefix = String(id).slice(0, id.length - digits.length);
    const n = parseInt(digits || "0", 10);
    return [`${prefix}${n-1}`, id, `${prefix}${n+1}`];
  }

  async function imgExists(pubId){
    const url = deliveryUrl(pubId);
    return new Promise(resolve=>{
      const img = new Image();
      img.onload  = () => resolve({ ok:true,  url, pubId });
      img.onerror = () => resolve({ ok:false, url, pubId });
      img.src = url;
    });
  }

  function addCard(url, label){
    const el = document.createElement("div");
    el.className = "card";
    el.innerHTML = `
      <img class="thumb" src="${url}" alt="">
      <div class="cap">${label}</div>
      <a class="small" href="${url}" target="_blank" rel="noopener">Open original</a>
    `;
    grid.appendChild(el);
  }

  function* recentCandidates(shortId, startDate = new Date()){
    const venue = venueFromId(shortId);
    const months = ["January","February","March","April","May","June","July","August","September","October","November","December"];
    for(let d=0; d<LOOKBACK_DAYS; d++){
      const dt  = new Date(startDate.getTime() - d*864e5);
      const Y   = dt.getUTCFullYear();
      const M   = months[dt.getUTCMonth()];
      const mdY = String(dt.getUTCMonth()+1).padStart(2,"0")+"."+String(dt.getUTCDate()).padStart(2,"0")+"."+dt.getUTCFullYear();
      yield `${venue}/${Y}/${M}/${mdY}/${shortId}`; // month-in-path
      yield `${venue}/${Y}/${mdY}/${shortId}`;      // no-month
    }
  }

  async function findMainPublicId(shortOrPath){
    // If they pasted a full Cloudinary URL, strip to public_id
    if (/res\.cloudinary\.com/.test(shortOrPath)){
      const m = shortOrPath.match(/\/image\/upload\/(?:v\d+\/)?(.+?)(?:\.\w+)?$/);
      if (m) return m[1];
    }
    // If they pasted a full folder path, keep it
    if (shortOrPath.includes("/")) return shortOrPath.trim();

    const shortId = shortOrPath.trim();
    for (const pubId of recentCandidates(shortId)){
      const probe = await imgExists(pubId);
      if (probe.ok) return pubId;
    }
    return null;
  }

  async function fetchNeighborsFromIndex(foundPubId){
    const folder = foundPubId.replace(/\/[^/]+$/, "");   // drop filename
    const file   = foundPubId.split("/").pop();
    const url    = rawUrl(folder);

    try{
      const res = await fetch(url, { cache: "no-store" });
      if (!res.ok) return null;
      const txt   = await res.text();
      const names = txt.split(/\r?\n/).map(s=>s.trim()).filter(Boolean);
      const i = names.indexOf(file);
      if (i === -1) return null;

      const picks = [];
      if (i-1 >= 0) picks.push(names[i-1]);
      picks.push(names[i]);
      if (i+1 < names.length) picks.push(names[i+1]);

      return picks.map(name => folder + "/" + name);
    }catch(e){
      return null;
    }
  }

  async function show(shortInput){
    grid.innerHTML = "";
    msg.textContent = "Searching…";

    const mainPubId = await findMainPublicId(shortInput);
    if (!mainPubId){
      msg.innerHTML = `<span style="color:#f88">Sorry, we couldn’t find that ID recently.</span>`;
      return;
    }

    // Prefer index.txt (exact ordering). Fallback to +/- 1.
    let pubIds = await fetchNeighborsFromIndex(mainPubId);
    if (!pubIds){
      const folder = mainPubId.replace(/\/[^/]+$/, "");
      const file   = mainPubId.split("/").pop();
      const [prev, cur, next] = plusMinusOne(file);
      pubIds = [`${folder}/${prev}`, `${folder}/${cur}`, `${folder}/${next}`];
    }

    const checks = await Promise.all(pubIds.map(pid => imgExists(pid)));
    const ok = checks.filter(c=>c.ok);

    if (ok.length){
      const centerName = mainPubId.split("/").pop();
      ok.forEach(c => {
        const name = c.pubId.split("/").pop();
        let label = "This photo";
        if (name < centerName) label = "Previous";
        if (name > centerName) label = "Next";
        addCard(c.url, `<b>${label}</b> · ${c.pubId}`);
      });
      msg.textContent = "Done.";
    }else{
      msg.textContent = "We found the folder, but neighbors didn’t render.";
    }
  }

  $("#goBtn").onclick = () => {
    const raw = $("#photoId").value.trim();
    if (!raw){ msg.textContent = "Please enter a Photo ID."; return; }
    show(raw);
  };
</script>
